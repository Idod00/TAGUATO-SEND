worker_processes auto;
error_log /usr/local/openresty/nginx/logs/error.log warn;

# Expose env vars to Lua (nginx strips env vars by default)
env AUTHENTICATION_API_KEY;
env PG_HOST;
env PG_PORT;
env PG_DATABASE;
env PG_USER;
env PG_PASSWORD;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    lua_package_path "/usr/local/openresty/nginx/lua/?.lua;;";

    # Docker internal DNS resolver
    resolver 127.0.0.11 ipv6=off;

    upstream evolution_api {
        server taguato-api:8080;
        keepalive 16;
    }

    server {
        listen 80;
        server_name _;

        # Increase body size for media uploads
        client_max_body_size 50m;

        # ---- Health check (no auth) ----
        location = /health {
            content_by_lua_block {
                ngx.say('{"status":"ok","gateway":"taguato"}')
            }
        }

        # ---- Admin endpoints (requires admin role) ----
        location /admin/ {
            access_by_lua_file /usr/local/openresty/nginx/lua/auth.lua;
            content_by_lua_file /usr/local/openresty/nginx/lua/admin.lua;
        }

        # ---- Manager (admin only, proxied to Evolution API) ----
        location /manager/ {
            access_by_lua_block {
                local token = ngx.req.get_headers()["apikey"]
                if not token or token == "" then
                    -- Manager UI serves static assets; allow through with API key
                    ngx.req.set_header("apikey", os.getenv("AUTHENTICATION_API_KEY"))
                    return
                end

                local db = require "init"
                local json = require "json"

                local res = db.query(
                    "SELECT id, role, is_active FROM taguato.users WHERE api_token = $1 LIMIT 1",
                    token
                )

                if not res or #res == 0 then
                    json.respond(401, { error = "Invalid API token" })
                    return
                end

                if not res[1].is_active then
                    json.respond(403, { error = "Account is disabled" })
                    return
                end

                if res[1].role ~= "admin" then
                    json.respond(403, { error = "Admin access required for Manager" })
                    return
                end

                ngx.req.set_header("apikey", os.getenv("AUTHENTICATION_API_KEY"))
            }

            proxy_pass http://evolution_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # ---- Swagger docs (admin only) ----
        location /docs {
            access_by_lua_block {
                local token = ngx.req.get_headers()["apikey"]
                if not token or token == "" then
                    ngx.req.set_header("apikey", os.getenv("AUTHENTICATION_API_KEY"))
                    return
                end

                local db = require "init"
                local json = require "json"

                local res = db.query(
                    "SELECT role, is_active FROM taguato.users WHERE api_token = $1 LIMIT 1",
                    token
                )

                if res and #res > 0 and res[1].is_active and res[1].role == "admin" then
                    ngx.req.set_header("apikey", os.getenv("AUTHENTICATION_API_KEY"))
                    return
                end

                json.respond(403, { error = "Admin access required" })
            }

            proxy_pass http://evolution_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_http_version 1.1;
        }

        # ---- Favicon (no auth) ----
        location = /favicon.ico {
            alias /usr/local/openresty/nginx/panel/favicon.ico;
            access_log off;
        }

        # ---- Panel static files ----
        location /panel/ {
            alias /usr/local/openresty/nginx/panel/;
            index index.html;
        }

        # ---- Panel auth endpoints ----
        location /api/auth/ {
            content_by_lua_file /usr/local/openresty/nginx/lua/panel_auth.lua;
        }

        # ---- Redirect root to panel for browsers ----
        location = / {
            content_by_lua_block {
                return ngx.redirect("/panel/", 302)
            }
        }

        # ---- All API requests (auth + instance filter + proxy) ----
        location / {
            access_by_lua_file /usr/local/openresty/nginx/lua/access.lua;

            proxy_pass http://evolution_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Response filter for fetchInstances
            body_filter_by_lua_file /usr/local/openresty/nginx/lua/response_filter.lua;
        }
    }
}
